<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Roster Credit Calculator</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root {
    --bg: #0c1117;
    --surface: #161b22;
    --surface2: #1c2333;
    --border: #2a3444;
    --text: #e6edf3;
    --text2: #8b949e;
    --accent: #58a6ff;
    --green: #3fb950;
    --orange: #d29922;
    --red: #f85149;
    --purple: #bc8cff;
    --radius: 12px;
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    padding: 1rem;
    -webkit-text-size-adjust: 100%;
}
.mono { font-family: 'JetBrains Mono', monospace; }
h1 { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.25rem; background: linear-gradient(135deg, var(--accent), var(--purple)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.subtitle { color: var(--text2); font-size: 0.85rem; margin-bottom: 1.5rem; }
.card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.25rem; margin-bottom: 1rem; }
.card-title { font-weight: 700; font-size: 0.9rem; color: var(--accent); margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; }
label { display: block; font-size: 0.8rem; color: var(--text2); margin-bottom: 0.35rem; font-weight: 500; }
select { width: 100%; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; color: var(--text); padding: 0.6rem 0.75rem; font-family: 'DM Sans', sans-serif; font-size: 0.9rem; margin-bottom: 0.75rem; -webkit-appearance: none; }
select:focus { outline: none; border-color: var(--accent); }
.file-label { display: flex; align-items: center; gap: 0.5rem; background: var(--surface2); border: 1px dashed var(--border); border-radius: 8px; padding: 0.75rem; margin-bottom: 0.75rem; cursor: pointer; transition: border-color 0.2s; font-size: 0.85rem; }
.file-label:hover { border-color: var(--accent); }
.file-label.loaded { border-color: var(--green); border-style: solid; }
.file-label .icon { font-size: 1.2rem; }
.file-label .status { color: var(--text2); margin-left: auto; font-size: 0.75rem; }
.file-label.loaded .status { color: var(--green); }
input[type="file"] { display: none; }
.btn { background: linear-gradient(135deg, var(--accent), var(--purple)); color: #fff; border: none; border-radius: 8px; padding: 0.75rem 1.5rem; font-family: 'DM Sans', sans-serif; font-weight: 700; font-size: 0.95rem; cursor: pointer; width: 100%; transition: opacity 0.2s; }
.btn:hover { opacity: 0.9; }
.btn:disabled { opacity: 0.4; cursor: not-allowed; }
.results { display: none; }
.results.show { display: block; }
.result-row { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid var(--border); }
.result-row:last-child { border-bottom: none; }
.result-label { font-size: 0.85rem; color: var(--text2); }
.result-value { font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: 1.1rem; }
.result-value.positive { color: var(--green); }
.result-value.zero { color: var(--text2); }
.result-value.highlight { color: var(--orange); font-size: 1.3rem; }
.summary-box { background: var(--surface2); border-radius: 8px; padding: 1rem; margin-top: 0.75rem; }
.summary-title { font-weight: 700; font-size: 0.8rem; color: var(--purple); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; }
.detail-toggle { color: var(--accent); font-size: 0.8rem; cursor: pointer; text-decoration: underline; margin-top: 0.5rem; display: inline-block; }
.detail-table { display: none; width: 100%; margin-top: 0.75rem; border-collapse: collapse; font-size: 0.75rem; }
.detail-table.show { display: table; }
.detail-table th { text-align: left; color: var(--text2); font-weight: 500; padding: 0.4rem 0.5rem; border-bottom: 1px solid var(--border); white-space: nowrap; }
.detail-table td { padding: 0.35rem 0.5rem; border-bottom: 1px solid var(--border); font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; white-space: nowrap; }
.detail-table tr.draft-row { background: rgba(188,140,255,0.1); }
.detail-table tr.infringement-row { background: rgba(248,81,73,0.1); }
.tag { display: inline-block; font-size: 0.65rem; padding: 0.15rem 0.4rem; border-radius: 4px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
.tag-fly { background: rgba(88,166,255,0.2); color: var(--accent); }
.tag-tvl { background: rgba(63,185,80,0.2); color: var(--green); }
.tag-sby { background: rgba(210,153,34,0.2); color: var(--orange); }
.tag-gnd { background: rgba(188,140,255,0.2); color: var(--purple); }
.tag-lve { background: rgba(248,81,73,0.2); color: var(--red); }
.tag-off { background: rgba(139,148,158,0.2); color: var(--text2); }
.tag-draft { background: rgba(188,140,255,0.3); color: var(--purple); }
.radio-label { display: inline-flex; align-items: center; gap: 0.35rem; background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 0.4rem 0.65rem; font-size: 0.8rem; cursor: pointer; transition: border-color 0.2s; }
.radio-label:hover { border-color: var(--accent); }
.radio-label input[type="radio"] { accent-color: var(--accent); margin: 0; }
.pay-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; margin-top: 0.5rem; }
.pay-table th { text-align: left; color: var(--text2); font-weight: 500; padding: 0.5rem; border-bottom: 1px solid var(--border); }
.pay-table td { padding: 0.5rem; border-bottom: 1px solid var(--border); font-size: 0.8rem; }
.pay-table tfoot td { padding: 0.6rem 0.5rem; border-bottom: none; }
.error-msg { background: rgba(248,81,73,0.1); border: 1px solid var(--red); border-radius: 8px; padding: 0.75rem; color: var(--red); font-size: 0.85rem; margin-bottom: 1rem; display: none; }
.error-msg.show { display: block; }
.divider { height: 1px; background: var(--border); margin: 1rem 0; }
@media(min-width:600px) { body { padding: 2rem; max-width: 700px; margin: 0 auto; } h1 { font-size: 2rem; } }
</style>
</head>
<body>

<h1>Roster Credit Calculator</h1>
<p class="subtitle">Virgin Australia â€” Overtime, Draft &amp; DDO Infringement</p>

<div id="errorMsg" class="error-msg"></div>

<div class="card">
    <div class="card-title">1. Select Roster Period</div>
    <label>Roster Period</label>
    <select id="rpSelect"><option value="">â€” Select a roster period â€”</option></select>
    <div id="rpInfo" style="font-size:0.8rem;color:var(--text2);"></div>
</div>

<div class="card">
    <div class="card-title">2. Load Roster Files</div>
    <label>Published Roster (RosterPublish.csv)</label>
    <label class="file-label" id="pubLabel"><span class="icon">ðŸ“„</span><span>Tap to select RosterPublish.csv</span><span class="status" id="pubStatus">Not loaded</span></label>
    <input type="file" id="pubFile" accept=".csv,.txt">
    <label>Completed Roster (RosterComplete.csv)</label>
    <label class="file-label" id="compLabel"><span class="icon">ðŸ“„</span><span>Tap to select RosterComplete.csv</span><span class="status" id="compStatus">Not loaded</span></label>
    <input type="file" id="compFile" accept=".csv,.txt">
</div>

<button class="btn" id="calcBtn" disabled onclick="runCalculation()">Calculate</button>

<div class="results" id="results">
    <div class="divider"></div>

    <div class="card">
        <div class="card-title">Roster Credit Protection (Published)</div>
        <div class="result-row"><span class="result-label">Total Published Credit</span><span class="result-value mono" id="rcpTotal">â€”</span></div>
        <div class="result-row"><span class="result-label">+ Vlearn</span><span class="result-value mono">0.75</span></div>
        <div class="result-row"><span class="result-label">Roster Credit Protection Total</span><span class="result-value mono highlight" id="rcpFinal">â€”</span></div>
        <div class="result-row"><span class="result-label" id="rcpMcgLabel">Less MCG (â€”)</span><span class="result-value mono" id="rcpMinusMCG">â€”</span></div>
        <span class="detail-toggle" onclick="toggleDetail('rcpDetail')">Show daily breakdown â–¾</span>
        <table class="detail-table" id="rcpDetail"><thead><tr><th>Date</th><th>Day</th><th>Type</th><th>Sectors</th><th>Credit</th><th>Rig</th><th>Final</th></tr></thead><tbody id="rcpDetailBody"></tbody></table>
    </div>

    <div class="card">
        <div class="card-title">Completed Roster Credit</div>
        <div class="result-row"><span class="result-label">Normal Days Credit</span><span class="result-value mono" id="crcNormal">â€”</span></div>
        <div class="result-row"><span class="result-label">+ Vlearn</span><span class="result-value mono">0.75</span></div>
        <div class="result-row"><span class="result-label">Completed Roster Credit Total</span><span class="result-value mono highlight" id="crcFinal">â€”</span></div>
        <div class="result-row"><span class="result-label" id="crcMcgLabel">Less MCG (â€”)</span><span class="result-value mono" id="crcMinusMCG">â€”</span></div>
        <span class="detail-toggle" onclick="toggleDetail('crcDetail')">Show daily breakdown â–¾</span>
        <table class="detail-table" id="crcDetail"><thead><tr><th>Date</th><th>Day</th><th>Type</th><th>Sectors</th><th>Credit</th><th>Rig</th><th>Final</th></tr></thead><tbody id="crcDetailBody"></tbody></table>
    </div>

    <div class="card">
        <div class="card-title">Draft</div>
        <div class="result-row"><span class="result-label">Draft Days Credit</span><span class="result-value mono" id="draftTotal">â€”</span></div>
        <span class="detail-toggle" onclick="toggleDetail('draftDetail')">Show draft breakdown â–¾</span>
        <table class="detail-table" id="draftDetail"><thead><tr><th>Date</th><th>Day</th><th>Pub Duty</th><th>Sectors</th><th>Credit</th><th>Rig</th><th>Min 5.0</th><th>Final</th></tr></thead><tbody id="draftDetailBody"></tbody></table>
    </div>

    <div class="card">
        <div class="card-title">DDO Infringement</div>
        <div class="result-row"><span class="result-label">DDO Infringement Credit</span><span class="result-value mono" id="ddoTotal">â€”</span></div>
        <span class="detail-toggle" onclick="toggleDetail('ddoDetail')">Show infringement breakdown â–¾</span>
        <table class="detail-table" id="ddoDetail"><thead><tr><th>DDO Block</th><th>Required</th><th>Actual</th><th>Shortfall</th><th>Credit</th></tr></thead><tbody id="ddoDetailBody"></tbody></table>
    </div>

    <div class="card" style="border-color:var(--accent);">
        <div class="card-title" style="color:var(--green);">Summary â€” Payment Due</div>
        <div class="summary-box">
            <div class="result-row"><span class="result-label" id="sumCRCLabel">Completed Roster Credit âˆ’ MCG (Overtime basis)</span><span class="result-value mono" id="sumCRC">â€”</span></div>
            <div class="result-row"><span class="result-label" id="sumRCPLabel">Roster Credit Protection âˆ’ MCG (Protection basis)</span><span class="result-value mono" id="sumRCP">â€”</span></div>
            <div class="result-row" style="border-bottom:none;"><span class="result-label" style="font-weight:700;color:var(--text);">Overtime Paid (higher of above)</span><span class="result-value mono highlight" id="sumOT">â€”</span></div>
        </div>
        <div class="summary-box" style="margin-top:0.5rem;">
            <div class="result-row"><span class="result-label">Draft Total</span><span class="result-value mono positive" id="sumDraft">â€”</span></div>
        </div>
        <div class="summary-box" style="margin-top:0.5rem;">
            <div class="result-row" style="border-bottom:none;"><span class="result-label">DDO Infringement Total</span><span class="result-value mono positive" id="sumDDO">â€”</span></div>
        </div>
    </div>

    <div class="card" id="paySection" style="display:none;">
        <div class="card-title" style="color:var(--orange);">Pay Calculation</div>
        <label>Role</label>
        <div style="display:flex;flex-wrap:wrap;gap:0.5rem;margin-bottom:0.75rem;">
            <label class="radio-label"><input type="radio" name="role" value="CPT" checked> Captain</label>
            <label class="radio-label"><input type="radio" name="role" value="FO"> First Officer</label>
            <label class="radio-label"><input type="radio" name="role" value="CHKCPT"> Check Captain</label>
            <label class="radio-label"><input type="radio" name="role" value="SNTCPT"> Sr Training Captain</label>
            <label class="radio-label"><input type="radio" name="role" value="TNCPT"> Training Captain</label>
            <label class="radio-label"><input type="radio" name="role" value="TNFO"> Training First Officer</label>
        </div>
        <label>Employment Type</label>
        <div style="display:flex;flex-wrap:wrap;gap:0.5rem;margin-bottom:1rem;">
            <label class="radio-label"><input type="radio" name="emptype" value="FT" checked> Full Time</label>
            <label class="radio-label"><input type="radio" name="emptype" value="PT75"> Part Time 75</label>
            <label class="radio-label"><input type="radio" name="emptype" value="PT50"> Part Time 50</label>
        </div>
        <table class="pay-table" id="payTable">
            <thead><tr><th>Description</th><th>Rate</th><th>Hours</th><th>Amount</th></tr></thead>
            <tbody>
                <tr><td>Salary Standard</td><td class="mono" id="paySalRate">â€”</td><td class="mono" id="paySalHrs">â€”</td><td class="mono" id="paySalAmt">â€”</td></tr>
                <tr><td>Extra Flight Hours</td><td class="mono" id="payOTRate">â€”</td><td class="mono" id="payOTHrs">â€”</td><td class="mono" id="payOTAmt">â€”</td></tr>
                <tr><td>FC Worked Day Off Hours</td><td class="mono" id="payDraftRate">â€”</td><td class="mono" id="payDraftHrs">â€”</td><td class="mono" id="payDraftAmt">â€”</td></tr>
                <tr><td>FC Infringement Payment</td><td class="mono" id="payDDORate">â€”</td><td class="mono" id="payDDOHrs">â€”</td><td class="mono" id="payDDOAmt">â€”</td></tr>
            </tbody>
            <tfoot><tr style="border-top:2px solid var(--accent);"><td style="font-weight:700;color:var(--text);">Total</td><td></td><td></td><td class="mono" style="font-weight:700;color:var(--green);font-size:1.1rem;" id="payTotal">â€”</td></tr></tfoot>
        </table>
    </div>
</div>

<script>
// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                                                                            â•‘
// â•‘                         USER CONFIGURATION                                 â•‘
// â•‘                                                                            â•‘
// â•‘  Edit the values below as needed. Do not modify anything below the         â•‘
// â•‘  configuration section unless you know what you are doing.                 â•‘
// â•‘                                                                            â•‘
// â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£

// â”€â”€ Vlearn credit (added once per roster period) â”€â”€
var VLEARN_CREDIT = 0.75;

// â”€â”€ Leave credit (per day) â”€â”€
var LEAVE_CREDIT = 2.46;

// â”€â”€ Standby credit (per day) â”€â”€
var SBY_CREDIT = 4.0;

// â”€â”€ Ground duty credit (per day) â”€â”€
var GROUND_CREDIT = 4.5;

// â”€â”€ Draft minimum credit (per day) â”€â”€
var DRAFT_MINIMUM = 5.0;

// â”€â”€ TVL minimum credit (when TVL is only duty for the day) â”€â”€
var TVL_MINIMUM = 2.0;

// â”€â”€ Standard hours per fortnight by employment type â”€â”€
var STD_HOURS = { FT: 80, PT75: 60, PT50: 40 };

// â”€â”€ Ground Duty Codes (4.5 credit each) â”€â”€
var GROUND_DUTIES = [
    "ADHOC","ADMN","CAPS","CAT","CMDGS","CPC1","CPC2","CPC3","CPC4","CPC5","CPC6","CPC7",
    "CPT1","CPT2","CPT3","CPT4","CPT5","CPT6","CPT7","CRM",
    "CSIM1","CSIM2","CSIM3","CSIM4","CSIM5","CSIM6","CSIM7","CSIM8","CSIM9",
    "DSTW","EPT","FRMSC","FRMSG","FRMSP","GPT7","GRDSCH","INTS","LVOP","LVTO","MDTR",
    "NTS","NTSADH","NTSADM","NTSSEP","OCCDR2","PCMDGS",
    "RTP2-24_A","RTP2-24_B","RTP3-25_A","RTP3-25_B","RTP4-25_A","RTP4-25_B",
    "SECDG","SECTRNG","SEMNR","SEP","SIM","SIM1","SIM2","SIM3","SIM3A","SIM3B",
    "SIMIGS","SIMSUP","TRNGSIM","TTT","UPRT","VSEC","VSEP","VSIM","VSIMI","VSIMP",
    "ZQDST1","ZQDST2","ZQDST3","ZQSR"
];

// â”€â”€ Leave / Sick Duty Codes (2.46 credit each) â”€â”€
var LEAVE_DUTIES = ["ALV","ALVA","ALVC","LSL","C/L","SICK"];

// â”€â”€ Zero Credit Duty Codes (0 credit, skipped) â”€â”€
var ZERO_DUTIES = ["ADO","BLANK","DDO","PDO","RDO","SOCDD","SOCT"];

// â”€â”€ Full Time Annual Base Salary â”€â”€
// Columns: [Commencement, after 1 Jul 2025, after 1 Jul 2026]
var SALARY_FT = {
    CPT:    [281750.00, 290202.50, 298908.58],
    FO:     [183137.50, 188631.63, 194290.57],
    CHKCPT: [326830.00, 336634.90, 346733.95],
    SNTCPT: [318377.50, 327928.83, 337766.69],
    TNCPT:  [309925.00, 319222.75, 328799.43],
    TNFO:   [211312.50, 217651.88, 224181.43]
};

// â”€â”€ Part Time 50 Annual Base Salary â”€â”€
var SALARY_PT50 = {
    CPT:    [146342.56, 150732.84, 155254.82],
    FO:     [95122.66, 97976.34, 100915.63],
    CHKCPT: [169757.37, 174850.09, 180095.59],
    SNTCPT: [165367.09, 170328.11, 175437.95],
    TNCPT:  [160976.82, 165806.12, 170780.30],
    TNFO:   [109756.92, 113049.63, 116441.12]
};

// â”€â”€ Part Time 75 Annual Base Salary â”€â”€
var SALARY_PT75 = {
    CPT:    [214046.28, 220467.67, 227081.70],
    FO:     [139130.08, 143303.98, 147603.10],
    CHKCPT: [248293.68, 255742.50, 263414.77],
    SNTCPT: [241872.30, 249128.47, 256602.32],
    TNCPT:  [235450.91, 242514.44, 249789.87],
    TNFO:   [160534.71, 165350.75, 170311.27]
};

// â”€â”€ Productivity Rates (per credit) â”€â”€
// Columns: [Commencement, after 1 Jul 2025, after 1 Jul 2026]
var PROD_RATES = {
    CPT:    [364.50, 375.44, 386.70],
    FO:     [236.93, 244.04, 251.36],
    CHKCPT: [422.82, 435.51, 448.57],
    SNTCPT: [411.89, 424.25, 436.97],
    TNCPT:  [400.95, 412.98, 425.37],
    TNFO:   [273.38, 281.58, 290.03]
};

// â”€â”€ Scheduled Flight Times (Sector â†’ "H:MM") â”€â”€
var SCHED_FT = {
    "ADL ASP":"2:05","ADL BNE":"2:30","ADL CBR":"1:35","ADL CNS":"3:10","ADL DRW":"4:00",
    "ADL MEL":"1:20","ADL OOL":"2:20","ADL PER":"3:20","ADL SYD":"1:55",
    "APW BNE":"5:45","ASP ADL":"2:05","AYQ BNE":"3:15","AYQ MEL":"2:50","AYQ SYD":"2:24",
    "BME PER":"2:35",
    "BNE ADL":"2:45","BNE APW":"4:45","BNE AYQ":"3:45","BNE CBR":"1:50","BNE CNS":"2:25",
    "BNE DPS":"6:15","BNE DRW":"4:10","BNE HBA":"2:50","BNE HTI":"1:50","BNE LST":"2:40",
    "BNE MCY":"0:45","BNE MEL":"2:20","BNE MKY":"1:35","BNE NAN":"3:40","BNE PER":"5:25",
    "BNE PPP":"1:40","BNE ROK":"1:20","BNE SYD":"1:35","BNE TSV":"2:10","BNE ZQN":"3:30",
    "BNK SYD":"1:20",
    "CBR ADL":"1:45","CBR BNE":"1:40","CBR MEL":"1:15","CBR OOL":"1:35","CBR SYD":"1:00",
    "CHC SYD":"3:25","CHC ZQN":"0:55",
    "CNS ADL":"3:15","CNS BNE":"2:20","CNS MEL":"3:25","CNS SYD":"3:00",
    "DPS BNE":"5:55","DPS MEL":"5:40","DPS SYD":"6:10",
    "DRW ADL":"3:50","DRW BNE":"3:50","DRW MEL":"4:20","DRW PER":"3:50","DRW SYD":"4:30",
    "HBA BNE":"2:40","HBA MEL":"1:20","HBA SYD":"1:50",
    "HTI BNE":"1:35","HTI SYD":"2:20",
    "KGI PER":"1:10","KNX PER":"3:35","KTA PER":"2:05",
    "LST BNE":"2:30","LST MEL":"1:05","LST PER":"4:40","LST SYD":"1:35",
    "MCY BNE":"0:01","MCY MEL":"2:35","MCY SYD":"1:35",
    "MEL ADL":"1:20","MEL AYQ":"3:20","MEL BNE":"2:10","MEL CBR":"1:05","MEL CNS":"3:25",
    "MEL DPS":"6:10","MEL DRW":"4:40","MEL HBA":"1:15","MEL LST":"1:05","MEL MCY":"2:20",
    "MEL NAN":"5:00","MEL NTL":"1:35","MEL OOL":"2:10","MEL PER":"4:25","MEL SYD":"1:25",
    "MEL TSV":"3:05","MEL ZQN":"3:10",
    "MKY BNE":"1:30",
    "NAN BNE":"4:05","NAN MEL":"5:35","NAN SYD":"4:45",
    "NTL MEL":"1:40",
    "OCM PER":"1:50","OOD PER":"1:55",
    "OOL ADL":"2:40","OOL CBR":"1:40","OOL DPS":"6:25","OOL MEL":"2:20","OOL SYD":"1:30",
    "PER ADL":"2:50","PER BME":"2:40","PER BNE":"4:30","PER DRW":"3:40","PER KGI":"1:05",
    "PER KNX":"3:10","PER KTA":"2:00","PER LST":"4:05","PER MEL":"3:35","PER OCM":"1:50",
    "PER OOD":"1:55","PER PHE":"2:10","PER SYD":"4:15","PER ZNE":"1:45",
    "PHE PER":"2:05",
    "PPP BNE":"1:35",
    "ROK BNE":"1:10",
    "SYD ADL":"2:10","SYD AYQ":"2:24","SYD BNE":"1:30","SYD BNK":"1:15","SYD CBR":"1:00",
    "SYD CNS":"3:05","SYD DPS":"6:30","SYD DRW":"4:30","SYD HBA":"1:55","SYD HTI":"2:30",
    "SYD LST":"1:50","SYD MCY":"1:35","SYD MEL":"1:35","SYD NAN":"4:15","SYD OOL":"1:20",
    "SYD PER":"5:05","SYD TSV":"2:45","SYD ZQN":"3:00",
    "TSV BNE":"1:55","TSV MEL":"3:05","TSV SYD":"2:40",
    "ZNE PER":"1:45",
    "ZQN BNE":"3:45","ZQN MEL":"3:35","ZQN SYD":"3:20"
};

// â”€â”€ Roster Periods â”€â”€
var ROSTER_PERIODS = [
    {rp:"RP1 - 2025",start:"23-Dec-24",end:"19-Jan-25",mcg:70},
    {rp:"RP2 - 2025",start:"20-Jan-25",end:"16-Feb-25",mcg:65},
    {rp:"RP3 - 2025",start:"17-Feb-25",end:"16-Mar-25",mcg:65},
    {rp:"RP4 - 2025",start:"17-Mar-25",end:"13-Apr-25",mcg:70},
    {rp:"RP5 - 2025",start:"14-Apr-25",end:"11-May-25",mcg:70},
    {rp:"RP6 - 2025",start:"12-May-25",end:"08-Jun-25",mcg:65},
    {rp:"RP7 - 2025",start:"09-Jun-25",end:"06-Jul-25",mcg:70},
    {rp:"RP8 - 2025",start:"07-Jul-25",end:"03-Aug-25",mcg:70},
    {rp:"RP9 - 2025",start:"04-Aug-25",end:"31-Aug-25",mcg:65},
    {rp:"RP10 - 2025",start:"01-Sep-25",end:"28-Sep-25",mcg:70},
    {rp:"RP11 - 2025",start:"29-Sep-25",end:"26-Oct-25",mcg:65},
    {rp:"RP12 - 2025",start:"27-Oct-25",end:"23-Nov-25",mcg:65},
    {rp:"RP13 - 2025",start:"24-Nov-25",end:"21-Dec-25",mcg:70},
    {rp:"RP1 - 2026",start:"22-Dec-25",end:"18-Jan-26",mcg:70},
    {rp:"RP2 - 2026",start:"19-Jan-26",end:"15-Feb-26",mcg:65},
    {rp:"RP3 - 2026",start:"16-Feb-26",end:"15-Mar-26",mcg:65},
    {rp:"RP4 - 2026",start:"16-Mar-26",end:"12-Apr-26",mcg:70},
    {rp:"RP5 - 2026",start:"13-Apr-26",end:"10-May-26",mcg:65},
    {rp:"RP6 - 2026",start:"11-May-26",end:"07-Jun-26",mcg:65},
    {rp:"RP7 - 2026",start:"08-Jun-26",end:"05-Jul-26",mcg:70},
    {rp:"RP8 - 2026",start:"06-Jul-26",end:"02-Aug-26",mcg:70},
    {rp:"RP9 - 2026",start:"03-Aug-26",end:"30-Aug-26",mcg:0},
    {rp:"RP10 - 2026",start:"31-Aug-26",end:"27-Sep-26",mcg:0},
    {rp:"RP11 - 2026",start:"28-Sep-26",end:"25-Oct-26",mcg:0},
    {rp:"RP12 - 2026",start:"26-Oct-26",end:"22-Nov-26",mcg:0},
    {rp:"RP13 - 2026",start:"23-Nov-26",end:"20-Dec-26",mcg:0},
    {rp:"RP1 - 2027",start:"21-Dec-26",end:"17-Jan-27",mcg:0},
    {rp:"RP2 - 2027",start:"18-Jan-27",end:"14-Feb-27",mcg:0},
    {rp:"RP3 - 2027",start:"15-Feb-27",end:"14-Mar-27",mcg:0},
    {rp:"RP4 - 2027",start:"15-Mar-27",end:"11-Apr-27",mcg:0},
    {rp:"RP5 - 2027",start:"12-Apr-27",end:"09-May-27",mcg:0},
    {rp:"RP6 - 2027",start:"10-May-27",end:"06-Jun-27",mcg:0},
    {rp:"RP7 - 2027",start:"07-Jun-27",end:"04-Jul-27",mcg:0},
    {rp:"RP8 - 2027",start:"05-Jul-27",end:"01-Aug-27",mcg:0},
    {rp:"RP9 - 2027",start:"02-Aug-27",end:"29-Aug-27",mcg:0},
    {rp:"RP10 - 2027",start:"30-Aug-27",end:"26-Sep-27",mcg:0},
    {rp:"RP11 - 2027",start:"27-Sep-27",end:"24-Oct-27",mcg:0},
    {rp:"RP12 - 2027",start:"25-Oct-27",end:"21-Nov-27",mcg:0},
    {rp:"RP13 - 2027",start:"22-Nov-27",end:"19-Dec-27",mcg:0}
];

// â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
// â•‘     DO NOT MODIFY ANYTHING BELOW THIS LINE                                 â•‘
// â•‘     Unless you know what you are doing.                                    â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function cleanDuty(d) { return (d||'').trim().replace(/^\$\s*/,'').toUpperCase(); }
function timeToDecimal(t) {
    if (!t||t.trim()===''||t==='0') return 0;
    var p=t.trim().split(':'); if(p.length!==2) return 0;
    return Math.round((parseInt(p[0],10)+(parseInt(p[1],10)/60))*100)/100;
}
function dec2(v) { return v.toFixed(2); }
function r2(v) { return Math.round(v*100)/100; }
function parseRPDate(s) { var m={Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11}; var p=s.split('-'); return new Date(2000+parseInt(p[2],10),m[p[1]],parseInt(p[0],10)); }
function parseRosterDate(s) {
    if(!s||s.trim()==='') return null; s=s.trim().toUpperCase();
    var m={JAN:0,FEB:1,MAR:2,APR:3,MAY:4,JUN:5,JUL:6,AUG:7,SEP:8,OCT:9,NOV:10,DEC:11};
    var d=parseInt(s.substring(0,2),10),mo=s.substring(2,5),y=parseInt(s.substring(5,7),10)+2000;
    return m[mo]!==undefined?new Date(y,m[mo],d):null;
}
function dateKey(d) { return d.getFullYear()*10000+(d.getMonth()+1)*100+d.getDate(); }
function isDutyType(d,l) { return l.indexOf(d)!==-1; }
function isSBY(d) { return d.indexOf('SBY')===0; }
function isFLY(d) { return d==='FLY'; }
function isTVL(d) { return d==='TVL'; }
function getSchedFT(s) { return SCHED_FT[s]||null; }
function getPayPeriodIndex(rpEndDate) {
    if(rpEndDate>=new Date(2026,6,1)) return 2;
    if(rpEndDate>=new Date(2025,6,1)) return 1;
    return 0;
}

function parseCSV(text) {
    var lines=text.split('\n'), data=[];
    for(var i=0;i<lines.length;i++){
        var line=lines[i].trim();
        if(line===''||line.toUpperCase()==='PUBLISH'||line.toUpperCase()==='COMPLETE'||line.indexOf('Start Date,')===0) continue;
        var cols=line.split(','); if(cols.length<16) continue;
        var ds=cols[0].trim(); if(!ds||!parseRosterDate(ds)) continue;
        data.push({date:ds,dateObj:parseRosterDate(ds),day:cols[1].trim(),fltNum:cols[2].trim(),sector:cols[3].trim(),ac:cols[4].trim(),duty:cols[5].trim(),pairingDuty:cols[6].trim(),rpt:cols[7].trim(),std:cols[8].trim(),sta:cols[9].trim(),signOff:cols[10].trim(),fltTime:cols[11].trim(),dutyTime:cols[12].trim(),hotel:cols[13].trim(),training:cols[14].trim(),remarks:cols[15].trim()});
    }
    return data;
}
function filterByDateRange(data,s,e) { var sk=dateKey(s),ek=dateKey(e); return data.filter(function(r){var dk=dateKey(r.dateObj);return dk>=sk&&dk<=ek;}); }
function groupByDate(rows) {
    var g={},o=[];
    for(var i=0;i<rows.length;i++){var dk=dateKey(rows[i].dateObj);if(!g[dk]){g[dk]=[];o.push(dk);}g[dk].push(rows[i]);}
    return{groups:g,order:o};
}

function calcDayCredit(dayRows, mode, pubDayRows) {
    var firstRow=dayRows[0], dutyRaw=cleanDuty(firstRow.duty);

    if(isDutyType(dutyRaw,ZERO_DUTIES)) return{credit:0,dutyRig:0,final:0,type:'off',sectors:'',isDraft:false,draftCredit:0,leaveDraftCRC:0,tag:'tag-off',label:dutyRaw};
    if(isDutyType(dutyRaw,LEAVE_DUTIES)) return{credit:LEAVE_CREDIT,dutyRig:0,final:LEAVE_CREDIT,type:'leave',sectors:'',isDraft:false,draftCredit:0,leaveDraftCRC:0,tag:'tag-lve',label:dutyRaw};

    var isDraft=false, pubDutyForDraft='';
    if(mode==='complete'&&pubDayRows){
        var pubDuty=cleanDuty(pubDayRows[0].duty);
        var pubIsZero=isDutyType(pubDuty,ZERO_DUTIES), pubIsLeave=isDutyType(pubDuty,LEAVE_DUTIES);
        if(pubIsZero||pubIsLeave){
            for(var d=0;d<dayRows.length;d++){
                var cd=cleanDuty(dayRows[d].duty);
                if(isFLY(cd)||isTVL(cd)||isDutyType(cd,GROUND_DUTIES)||isSBY(cd)){isDraft=true;pubDutyForDraft=pubDuty;break;}
            }
        }
    }

    if(mode==='complete'&&pubDayRows&&isDutyType(dutyRaw,LEAVE_DUTIES)){
        return{credit:LEAVE_CREDIT,dutyRig:0,final:LEAVE_CREDIT,type:'leave',sectors:'',isDraft:false,draftCredit:0,leaveDraftCRC:0,tag:'tag-lve',label:dutyRaw};
    }

    var dailyTotal=0, hasFly=false, sectorList=[], dutyTimeDecimal=0, onlyTVL=true;
    if(firstRow.dutyTime&&firstRow.dutyTime!=='0') dutyTimeDecimal=timeToDecimal(firstRow.dutyTime);

    if(isSBY(dutyRaw)){
        var sbyCredit=SBY_CREDIT;
        var leaveCRC=0;
        if(isDraft){
            var dc=Math.max(sbyCredit,DRAFT_MINIMUM);
            if(isDutyType(pubDutyForDraft,LEAVE_DUTIES)) leaveCRC=LEAVE_CREDIT;
            return{credit:sbyCredit,dutyRig:0,final:sbyCredit,type:'sby',sectors:'',isDraft:true,draftCredit:dc,leaveDraftCRC:leaveCRC,tag:'tag-sby',label:dutyRaw};
        }
        return{credit:sbyCredit,dutyRig:0,final:sbyCredit,type:'sby',sectors:'',isDraft:false,draftCredit:0,leaveDraftCRC:0,tag:'tag-sby',label:dutyRaw};
    }

    for(var i=0;i<dayRows.length;i++){
        var row=dayRows[i], duty=cleanDuty(row.duty), sector=row.sector.trim(), fltTime=row.fltTime.trim();
        if(isFLY(duty)){
            hasFly=true; onlyTVL=false;
            var ft=timeToDecimal(fltTime);
            if(mode==='complete'&&pubDayRows){
                var pubFT=0;
                for(var p=0;p<pubDayRows.length;p++){
                    if(pubDayRows[p].sector.trim()===sector&&cleanDuty(pubDayRows[p].duty)==='FLY'){pubFT=timeToDecimal(pubDayRows[p].fltTime);break;}
                }
                if(isDraft&&pubFT===0){var st=getSchedFT(sector);if(st)pubFT=timeToDecimal(st);}
                ft=r2(Math.max(ft,pubFT));
            }
            dailyTotal=r2(dailyTotal+ft); sectorList.push(sector);
        } else if(isTVL(duty)){
            var tvlFT=timeToDecimal(fltTime);
            var pairingRole=(row.pairingDuty||'').trim().toUpperCase();
            var isDIS=(mode==='complete'&&pairingRole==='DIS');
            var tvlCredit=isDIS?tvlFT:r2(tvlFT/2);
            if(mode==='complete'&&pubDayRows){
                var pubTvlFT=0;
                for(var p2=0;p2<pubDayRows.length;p2++){
                    if(pubDayRows[p2].sector.trim()===sector&&cleanDuty(pubDayRows[p2].duty)==='TVL'){pubTvlFT=timeToDecimal(pubDayRows[p2].fltTime);break;}
                }
                if(isDraft&&pubTvlFT===0){var st2=getSchedFT(sector);if(st2)pubTvlFT=timeToDecimal(st2);}
                var higherFT=Math.max(tvlFT,pubTvlFT);
                tvlCredit=isDIS?higherFT:r2(higherFT/2);
            }
            dailyTotal=r2(dailyTotal+tvlCredit); sectorList.push(sector+(isDIS?'(DIS)':'(T)'));
        } else if(isDutyType(duty,GROUND_DUTIES)){
            onlyTVL=false; dailyTotal=r2(dailyTotal+GROUND_CREDIT); sectorList.push(duty);
        } else if(isDutyType(duty,LEAVE_DUTIES)){
            onlyTVL=false; dailyTotal=r2(dailyTotal+LEAVE_CREDIT);
        } else if(isSBY(duty)){
            onlyTVL=false; dailyTotal=r2(dailyTotal+SBY_CREDIT);
        }
        if(!isTVL(duty)) onlyTVL=false;
    }

    if(onlyTVL&&dailyTotal<TVL_MINIMUM) dailyTotal=TVL_MINIMUM;

    var dutyRig=0, finalCredit=dailyTotal;
    if(hasFly&&dutyTimeDecimal>0){
        dutyRig=r2(dutyTimeDecimal/2);
        if(dutyRig>dailyTotal) finalCredit=dutyRig;
    }

    var draftCredit=0, leaveDraftCRC2=0;
    if(isDraft){
        draftCredit=Math.max(finalCredit,DRAFT_MINIMUM);
        if(isDutyType(pubDutyForDraft,LEAVE_DUTIES)) leaveDraftCRC2=LEAVE_CREDIT;
    }

    var typeLabel=hasFly?'fly':(onlyTVL?'tvl':'gnd');
    var tagClass=hasFly?'tag-fly':(onlyTVL?'tag-tvl':'tag-gnd');
    return{credit:dailyTotal,dutyRig:dutyRig,final:finalCredit,type:typeLabel,sectors:sectorList.join(', '),isDraft:isDraft,draftCredit:draftCredit,leaveDraftCRC:leaveDraftCRC2,tag:tagClass,label:isDraft?'DRAFT':dutyRaw};
}

function calcDDOInfringements(pubGrouped, compGrouped, compData) {
    var infringements=[], allDates=pubGrouped.order, i=0;
    while(i<allDates.length){
        var dk=allDates[i], pubRows=pubGrouped.groups[dk], pubDuty=cleanDuty(pubRows[0].duty);
        if(pubDuty==='DDO'){
            var compRows=compGrouped.groups[dk], compDuty=compRows?cleanDuty(compRows[0].duty):'';
            if(compDuty==='BLANK'){
                var ddoCount=1, j=i+1;
                while(j<allDates.length){
                    var ndk=allDates[j],npr=pubGrouped.groups[ndk],npd=cleanDuty(npr[0].duty);
                    var ncr=compGrouped.groups[ndk],ncd=ncr?cleanDuty(ncr[0].duty):'';
                    if(npd==='DDO'&&ncd==='BLANK'){ddoCount++;j++;}else break;
                }
                var requiredHrs=36+(ddoCount-1)*24, prevSignOff=null, blockLastDk=allDates[j-1];
                for(var s=0;s<compData.length;s++){
                    if(dateKey(compData[s].dateObj)<dk&&compData[s].signOff&&compData[s].signOff.trim()!=='')
                        prevSignOff={date:compData[s].dateObj,time:compData[s].signOff.trim(),dateStr:compData[s].date};
                }
                var nextSignOn=null;
                for(var n=0;n<compData.length;n++){
                    if(dateKey(compData[n].dateObj)>blockLastDk&&compData[n].rpt&&compData[n].rpt.trim()!==''){
                        nextSignOn={date:compData[n].dateObj,time:compData[n].rpt.trim(),dateStr:compData[n].date};break;
                    }
                }
                if(prevSignOff&&nextSignOn){
                    var soH=parseInt(prevSignOff.time.substring(0,2),10)||0,soM=parseInt(prevSignOff.time.substring(2,4),10)||0;
                    var soDT=new Date(prevSignOff.date);soDT.setHours(soH,soM,0,0);
                    var siH=parseInt(nextSignOn.time.substring(0,2),10)||0,siM=parseInt(nextSignOn.time.substring(2,4),10)||0;
                    var siDT=new Date(nextSignOn.date);siDT.setHours(siH,siM,0,0);
                    var actualHrs=(siDT-soDT)/(1000*60*60), shortfallHrs=requiredHrs-actualHrs;
                    if(shortfallHrs>0){
                        var shortfallMins=Math.round(shortfallHrs*60), credit=0;
                        if(shortfallMins>=1&&shortfallMins<=60) credit=2.0;
                        else if(shortfallMins>=61&&shortfallMins<=120) credit=4.0;
                        else if(shortfallMins>120) credit=5.0;
                        infringements.push({blockDates:pubRows[0].date+' - '+pubGrouped.groups[allDates[j-1]][0].date,ddoCount:ddoCount,requiredHrs:requiredHrs,actualHrs:Math.round(actualHrs*100)/100,shortfallMins:shortfallMins,credit:credit});
                    }
                }
                i=j;continue;
            }
        }
        i++;
    }
    return infringements;
}

// â”€â”€ UI Setup â”€â”€
var pubData=null, compData=null;
var sel=document.getElementById('rpSelect');
var today=new Date(), defaultIdx=-1;

for(var r=0;r<ROSTER_PERIODS.length;r++){
    var rp=ROSTER_PERIODS[r], opt=document.createElement('option');
    opt.value=r;
    opt.textContent=rp.rp+'  ('+rp.start+' â†’ '+rp.end+')  MCG: '+rp.mcg;
    sel.appendChild(opt);
    var rpStart=parseRPDate(rp.start), rpEnd=parseRPDate(rp.end);
    if(today>=rpStart&&today<=rpEnd) defaultIdx=r;
}
if(defaultIdx>=0){sel.value=defaultIdx;var drp=ROSTER_PERIODS[defaultIdx];document.getElementById('rpInfo').textContent=drp.start+' to '+drp.end+' | MCG: '+drp.mcg;}

sel.addEventListener('change',function(){
    var idx=this.value;
    if(idx!==''){var rp=ROSTER_PERIODS[idx];document.getElementById('rpInfo').textContent=rp.start+' to '+rp.end+' | MCG: '+rp.mcg;}
    else document.getElementById('rpInfo').textContent='';
    checkReady();
});

document.getElementById('pubLabel').addEventListener('click',function(){document.getElementById('pubFile').click();});
document.getElementById('compLabel').addEventListener('click',function(){document.getElementById('compFile').click();});
document.getElementById('pubFile').addEventListener('change',function(e){
    var f=e.target.files[0];if(f){var r=new FileReader();r.onload=function(ev){pubData=parseCSV(ev.target.result);document.getElementById('pubStatus').textContent=pubData.length+' rows';document.getElementById('pubLabel').classList.add('loaded');checkReady();};r.readAsText(f);}
});
document.getElementById('compFile').addEventListener('change',function(e){
    var f=e.target.files[0];if(f){var r=new FileReader();r.onload=function(ev){compData=parseCSV(ev.target.result);document.getElementById('compStatus').textContent=compData.length+' rows';document.getElementById('compLabel').classList.add('loaded');checkReady();};r.readAsText(f);}
});

function checkReady(){var btn=document.getElementById('calcBtn');btn.disabled=!(sel.value!==''&&pubData&&compData);}
function toggleDetail(id){document.getElementById(id).classList.toggle('show');}
function showError(m){var e=document.getElementById('errorMsg');e.textContent=m;e.classList.add('show');}
function clearError(){document.getElementById('errorMsg').classList.remove('show');}

function runCalculation(){
    clearError();
    document.getElementById('results').classList.remove('show');
    var rpIdx=sel.value; if(rpIdx===''){showError('Please select a roster period.');return;}
    var rp=ROSTER_PERIODS[rpIdx], startDate=parseRPDate(rp.start), endDate=parseRPDate(rp.end), mcg=rp.mcg;
    var pubFiltered=filterByDateRange(pubData,startDate,endDate), compFiltered=filterByDateRange(compData,startDate,endDate);
    if(pubFiltered.length===0){showError('No published roster data found for this period.');return;}
    if(compFiltered.length===0){showError('No completed roster data found for this period.');return;}
    var pubGrouped=groupByDate(pubFiltered), compGrouped=groupByDate(compFiltered);

    // â”€â”€ RCP â”€â”€
    var rcpRunning=0, rcpDetails=[];
    for(var a=0;a<pubGrouped.order.length;a++){
        var dk=pubGrouped.order[a], dayRows=pubGrouped.groups[dk];
        var res=calcDayCredit(dayRows,'publish',null);
        rcpRunning=r2(rcpRunning+res.final);
        if(res.final>0) rcpDetails.push({date:dayRows[0].date,day:dayRows[0].day,type:res.label,tag:res.tag,sectors:res.sectors,credit:res.credit,rig:res.dutyRig,final:res.final});
    }
    var rcpTotal=r2(rcpRunning+VLEARN_CREDIT);

    // â”€â”€ CRC â”€â”€
    var crcRunning=0, crcDetails=[], draftRunning=0, draftDetails=[];
    for(var b=0;b<compGrouped.order.length;b++){
        var dk2=compGrouped.order[b], compDayRows=compGrouped.groups[dk2], pubDayRows=pubGrouped.groups[dk2]||null;
        var res2=calcDayCredit(compDayRows,'complete',pubDayRows);
        if(res2.isDraft){
            draftRunning=r2(draftRunning+res2.draftCredit);
            // Leaveâ†’Draft: add 2.46 to CRC
            if(res2.leaveDraftCRC>0) crcRunning=r2(crcRunning+res2.leaveDraftCRC);
            draftDetails.push({date:compDayRows[0].date,day:compDayRows[0].day,pubDuty:pubDayRows?cleanDuty(pubDayRows[0].duty):'â€”',sectors:res2.sectors,credit:res2.credit,rig:res2.dutyRig,min5:Math.max(DRAFT_MINIMUM,res2.final),final:res2.draftCredit});
        } else {
            crcRunning=r2(crcRunning+res2.final);
            if(res2.final>0) crcDetails.push({date:compDayRows[0].date,day:compDayRows[0].day,type:res2.label,tag:res2.tag,sectors:res2.sectors,credit:res2.credit,rig:res2.dutyRig,final:res2.final});
        }
    }
    var crcTotal=r2(crcRunning+VLEARN_CREDIT);

    // â”€â”€ DDO Infringement â”€â”€
    var infringements=calcDDOInfringements(pubGrouped,compGrouped,compFiltered);
    var ddoTotal=0;
    for(var c=0;c<infringements.length;c++) ddoTotal+=infringements[c].credit;

    // â”€â”€ Populate UI â”€â”€
    document.getElementById('rcpTotal').textContent=dec2(rcpRunning);
    document.getElementById('rcpFinal').textContent=dec2(rcpTotal);
    document.getElementById('rcpMcgLabel').textContent='Less MCG ('+mcg+')';
    document.getElementById('rcpMinusMCG').textContent=dec2(Math.max(0,rcpTotal-mcg));

    document.getElementById('crcNormal').textContent=dec2(crcRunning);
    document.getElementById('crcFinal').textContent=dec2(crcTotal);
    document.getElementById('crcMcgLabel').textContent='Less MCG ('+mcg+')';
    document.getElementById('crcMinusMCG').textContent=dec2(Math.max(0,crcTotal-mcg));

    document.getElementById('draftTotal').textContent=dec2(draftRunning);
    document.getElementById('ddoTotal').textContent=dec2(ddoTotal);

    var crcMinusMCG=Math.max(0,crcTotal-mcg), rcpMinusMCG=Math.max(0,rcpTotal-mcg);
    var otPaid=Math.max(crcMinusMCG,rcpMinusMCG);

    document.getElementById('sumCRCLabel').textContent='Completed Roster Credit âˆ’ MCG ('+mcg+') (Overtime basis)';
    document.getElementById('sumRCPLabel').textContent='Roster Credit Protection âˆ’ MCG ('+mcg+') (Protection basis)';
    document.getElementById('sumCRC').textContent=dec2(crcMinusMCG);
    document.getElementById('sumRCP').textContent=dec2(rcpMinusMCG);
    document.getElementById('sumOT').textContent=dec2(otPaid);
    document.getElementById('sumOT').className='result-value mono '+(otPaid>0?'highlight':'zero');
    document.getElementById('sumDraft').textContent=dec2(draftRunning);
    document.getElementById('sumDDO').textContent=dec2(ddoTotal);

    // RCP detail
    var rcpBody=document.getElementById('rcpDetailBody');rcpBody.innerHTML='';
    for(var d=0;d<rcpDetails.length;d++){var rd=rcpDetails[d];rcpBody.innerHTML+='<tr><td>'+rd.date+'</td><td>'+rd.day+'</td><td><span class="tag '+rd.tag+'">'+rd.type+'</span></td><td>'+rd.sectors+'</td><td>'+dec2(rd.credit)+'</td><td>'+(rd.rig>0?dec2(rd.rig):'â€”')+'</td><td>'+dec2(rd.final)+'</td></tr>';}

    // CRC detail
    var crcBody=document.getElementById('crcDetailBody');crcBody.innerHTML='';
    for(var e=0;e<crcDetails.length;e++){var cd2=crcDetails[e];crcBody.innerHTML+='<tr><td>'+cd2.date+'</td><td>'+cd2.day+'</td><td><span class="tag '+cd2.tag+'">'+cd2.type+'</span></td><td>'+cd2.sectors+'</td><td>'+dec2(cd2.credit)+'</td><td>'+(cd2.rig>0?dec2(cd2.rig):'â€”')+'</td><td>'+dec2(cd2.final)+'</td></tr>';}

    // Draft detail
    var draftBody=document.getElementById('draftDetailBody');draftBody.innerHTML='';
    for(var f=0;f<draftDetails.length;f++){var dd=draftDetails[f];draftBody.innerHTML+='<tr class="draft-row"><td>'+dd.date+'</td><td>'+dd.day+'</td><td>'+dd.pubDuty+'</td><td>'+dd.sectors+'</td><td>'+dec2(dd.credit)+'</td><td>'+(dd.rig>0?dec2(dd.rig):'â€”')+'</td><td>'+dec2(dd.min5)+'</td><td>'+dec2(dd.final)+'</td></tr>';}
    if(draftDetails.length===0) draftBody.innerHTML='<tr><td colspan="8" style="text-align:center;color:var(--text2);">No draft days</td></tr>';

    // DDO detail
    var ddoBody=document.getElementById('ddoDetailBody');ddoBody.innerHTML='';
    for(var g=0;g<infringements.length;g++){var inf=infringements[g];ddoBody.innerHTML+='<tr class="infringement-row"><td>'+inf.blockDates+' ('+inf.ddoCount+' DDOs)</td><td>'+inf.requiredHrs+'h</td><td>'+inf.actualHrs+'h</td><td>'+inf.shortfallMins+' min</td><td>'+dec2(inf.credit)+'</td></tr>';}
    if(infringements.length===0) ddoBody.innerHTML='<tr><td colspan="5" style="text-align:center;color:var(--text2);">No infringements</td></tr>';

    window._calcResults={otPaid:otPaid,draftTotal:draftRunning,ddoTotal:ddoTotal,rpEndDate:endDate};
    document.getElementById('paySection').style.display='block';
    updatePayTable();

    document.getElementById('results').classList.add('show');
    document.getElementById('results').scrollIntoView({behavior:'smooth'});
}

function updatePayTable(){
    if(!window._calcResults) return;
    var role=document.querySelector('input[name="role"]:checked').value;
    var empType=document.querySelector('input[name="emptype"]:checked').value;
    var payIdx=getPayPeriodIndex(window._calcResults.rpEndDate);
    var salaryTable=empType==='PT50'?SALARY_PT50:(empType==='PT75'?SALARY_PT75:SALARY_FT);
    var annualSalary=salaryTable[role][payIdx];
    var salaryRate=annualSalary/26/80;
    var prodRate=PROD_RATES[role][payIdx];
    var stdHours=STD_HOURS[empType];
    var otHours=window._calcResults.otPaid, draftHours=window._calcResults.draftTotal, ddoHours=window._calcResults.ddoTotal;
    var salAmt=salaryRate*stdHours, otAmt=prodRate*otHours, draftAmt=prodRate*draftHours, ddoAmt=prodRate*ddoHours;
    var total=salAmt+otAmt+draftAmt+ddoAmt;
    var fmt=function(v){return '$'+v.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,',');};
    document.getElementById('paySalRate').textContent=fmt(salaryRate);
    document.getElementById('paySalHrs').textContent=stdHours.toFixed(2);
    document.getElementById('paySalAmt').textContent=fmt(salAmt);
    document.getElementById('payOTRate').textContent=fmt(prodRate);
    document.getElementById('payOTHrs').textContent=otHours.toFixed(2);
    document.getElementById('payOTAmt').textContent=fmt(otAmt);
    document.getElementById('payDraftRate').textContent=fmt(prodRate);
    document.getElementById('payDraftHrs').textContent=draftHours.toFixed(2);
    document.getElementById('payDraftAmt').textContent=fmt(draftAmt);
    document.getElementById('payDDORate').textContent=fmt(prodRate);
    document.getElementById('payDDOHrs').textContent=ddoHours.toFixed(2);
    document.getElementById('payDDOAmt').textContent=fmt(ddoAmt);
    document.getElementById('payTotal').textContent=fmt(total);
}

document.querySelectorAll('input[name="role"],input[name="emptype"]').forEach(function(el){el.addEventListener('change',updatePayTable);});
</script>
</body>
</html>
